WITH aff as
(
	SELECT dem.DEM_ID_PRM as POINT, dem.AFF_T_DISCO as AFFAIRE, nat.NAT_C_PRESTATION as PRESTATION, nat.NAT_C_SOUS_TYPE as "OPTION"
	, dem.DEM_D_EFFET DATE_EFFET
	FROM SUIVI.DEMANDE dem
	JOIN SUIVI.NATURE nat ON dem.DEM_K_NAT = nat.NAT_ID
	WHERE 1=1
	AND nat.NAT_C_PRESTATION IN ('F120B', 'F130B', 'F140', 'M007', 'M009')
)

SELECT aff.*, prm.PRM_SC_ETAT_CONTRACTUEL_CODE ETAT_CT 
FROM SGEL_PRM_SCH.T_PRM prm
JOIN SGEL_PRM_SCH.T_SITUATION_CONTRACTUELLE situ ON prm.SCN_ID = situ.SCN_ID
JOIN aff ON prm.PRM_ID = aff.POINT
WHERE 1=1
-- AND prm.PRM_ID = '14479884145604'
AND prm.PRM_ID IN @@IN1@@
ORDER BY prm.PRM_ID, aff.DATE_EFFET DESC