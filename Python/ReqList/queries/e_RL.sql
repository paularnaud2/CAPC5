WITH aff as (
	SELECT dem.DEM_ID_PRM as PRM, dem.AFF_T_DISCO as AFFAIRE, dem.DEM_D_EFFET as DATE_EFFET
	, DENSE_RANK() OVER (PARTITION BY dem.DEM_ID_PRM ORDER BY dem.DEM_D_EFFET DESC) as RANG
	FROM SUIVI.DEMANDE dem
	JOIN SUIVI.NATURE nat ON dem.DEM_K_NAT = nat.NAT_ID
	JOIN SUIVI.ETAT_STATUT ee ON dem.DEM_K_EST_EXT = ee.EST_ID
	WHERE 1=1
	AND nat.NAT_C_PRESTATION IN ('F120B')
	AND dem.DEM_R_STATUT = 'AFF-TERMINEE'
	AND ee.EST_T_ETAT = 'Close, prestation réalisée'
)

, t AS (
	SELECT prm.PRM_ID PRM, prm.PRM_SC_ETAT_CONTRACTUEL_CODE ETAT_CONTRACTUEL
	FROM SGEL_PRM_SCH.T_PRM prm
)

SELECT t.PRM, t.ETAT_CONTRACTUEL, aff.AFFAIRE DER_F120
, TO_CHAR(aff.DATE_EFFET, 'DD/MM/YYYY') DATE_EFFET
FROM t
LEFT JOIN aff ON t.PRM = aff.PRM
WHERE 1=1
AND t.PRM IN @@IN1@@
AND aff.RANG = '1'